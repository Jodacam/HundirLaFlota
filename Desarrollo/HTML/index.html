<html lang="es"> 
<head> 
	<meta charset="UTF-8" />
	<title>HLF Online</title>
	<script type="text/javascript" src="../JavaScript/phaser.js"></script>
    <script type="text/javascript" src="../JavaScript/jquery-3.2.1.js"></script>
</head>
<body>
    <script type = "text/javascript">
        "use strict";

        var game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.CANVAS, '', { preload: preload, create: create, update: update, render: render});

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        function Celda(x, y) {
            var posX;
            var posY;

            var rect;

            var colorA;
            var colorB;

            this.pintar = function(){
                bmd.rect(rect.x-2, rect.y-2, rect.width+4, rect.height+4, colorB);
                bmd.rect(rect.x+2, rect.y+2, rect.width-4, rect.height-4, colorA);
                bmd.addToWorld();

                /*
                var graphics = game.add.graphics(0, 0);
                graphics.lineStyle(6, colorB, 1);
                graphics.beginFill(colorA);
                graphics.drawRect(rect.x, rect.y, rect.width, rect.height); // coordenada X, coordenada Y, ancho y alto
                graphics.endFill();
                */
            };

            //Getters
            this.getPosX = function(){
                return posX;
            };

            this.getPosY = function(){
                return posY;
            };

            this.getColorA = function(){
                return colorA;
            };

            this.getColorB = function(){
                return colorB;
            };

            this.getRect = function(){
                return rect;
            };

            //Setters
            this.setPosX = function(x){
                posX = x;
            };

            this.setPosY = function(y){
                posY = y;
            };

            this.setColorA = function(a){
                colorA = a;
            };

            this.setColorB = function(b){
                colorB = b;
            };

            this.setRect = function(){
                rect = new Phaser.Rectangle(posX, posY, anchoTablero / 10, anchoTablero / 10);
                
            };
        };

        function CeldaA(x, y){
            Celda.call(this, x, y);

            this.setColorA('#0099ff');
            this.setColorB('#FFFFFF');

            var offsetX = (game.width) / 2 + 40;
            var offsetY = (game.height - anchoTablero) / 2;

            this.setPosX(x + offsetX);
            this.setPosY(y + offsetY);

            this.setRect();
        };

        function CeldaE(x, y){
            Celda.call(this, x, y);

            this.setColorA('#00ff99');
            this.setColorB('#000000');

            var offsetX = (game.width - anchoTablero * 2) / 2 - 40;
            var offsetY = (game.height - anchoTablero) / 2;

            this.setPosX(x + offsetX);
            this.setPosY(y + offsetY);

            this.setRect();            
        };



        function Tablero() {
            var tablero = new Array(10);

            for (var i = 0; i < 10; i++)
                tablero[i] = new Array(10);

            this.pintar = function(i, j){
                for(var i = 0; i < 10; i++){
                    for(var j = 0; j < 10; j++){
                        tablero[i][j].pintar();
                    }
                }
            };

            //Getters
            this.getTablero = function(){
                return tablero;
            };
        };

        function TableroA(){
            Tablero.call(this);

            this.generar = function(){
                for (var i = 0; i < 10; i++){
                    for (var j = 0; j < 10; j++){
                        this.getTablero()[i][j] = new CeldaA(i * anchoTablero / 10, j * anchoTablero / 10);
                    }
                }
            }
            this.checkRectangle = function (barco) {

                for (var i = 0; i < this.getTablero().length; i++) {
                    for (var j = 0; j < this.getTablero()[i].length; j++) {

                        var rect = this.getTablero()[i][j].getRect();

                        if (Phaser.Rectangle.contains(rect, game.input.x, game.input.y)) {
                            barco.changePosition(rect.x, rect.y);
                        }
                    }


                }
            }
        };

        function TableroE(){
            Tablero.call(this);

            this.generar = function(){
                for (var i = 0; i < 10; i++){
                    for (var j = 0; j < 10; j++){
                        this.getTablero()[i][j] = new CeldaE(i * anchoTablero / 10, j * anchoTablero / 10);
                    }
                }
            }
        };

        function Barco(sprite, nceldas, x, y) {
            var barco = game.add.sprite(x, y, sprite);
            barco.inputEnabled = true;
            barco.input.start(0, true);
            barco.events.onInputDown.add(select,barco,0,this);
            flota.add(barco);
            var partes = new Array(nceldas);
            //funciones
            this.changePosition = function (x, y) {
                barco.x = x;
                barco.y = y;
            }
            //Getters y Setters
            this.getSprite = function () {
                return barco;
            }


        };


        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        //Herencia
        CeldaA.prototype = new Celda();
        CeldaE.prototype = new Celda();

        TableroA.prototype = new Tablero();
        TableroE.prototype = new Tablero();

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


        var tableroAliado;
        var tableroEnemigo;
        var bmd;
        var lienzo;
        var barco;
        //Grupo en el que colocar los barcos para visualizarlos sobre los tableros
        var flota;

        //variable para detectar si se ha clicado
        var clicado = null;

        var anchura = window.innerWidth/2;
        var anchoTablero = anchura*0.7;
        var gameState ='';
        const PART_ONE = "parte1";
        const PART_TWO = 'parte2';
        const WAIT = 'espera';

        function preload(){
            game.load.image('barco2', 'images/Barco2Solo.png');
            game.load.image('barco3', 'images/Barco3Solo.png');
            game.load.image('barco4', 'images/Barco4Solo.png');
        }

        function create() {
            //Para pintar los rect de las celdas
            gameState = PART_ONE;
            bmd = game.add.bitmapData(game.width, game.height);


            flota = game.add.group();

            tableroAliado = new TableroA();
            tableroEnemigo = new TableroE();

            tableroAliado.generar();
            tableroEnemigo.generar();

            
            var prueba = new Barco('barco2', 0, 100, 100);

            //codigo para meter los barcos en una variable que los agrupe
           /* for (var i = 0; i < 1; i++) {
                barco = flota.create(20, 20, 'barco2',i);
                barco.inputEnabled = true;
                barco.input.start(0, true);
                barco.events.onInputDown.add(select);
            }*/

            tableroAliado.pintar();
            tableroEnemigo.pintar();
            
        }

        function setBarcoCasilla(rect, Celda) {
            console.log("pulsadacasilla")
            clicado.x = rect.x;
            clicado.y = rect.y;

        }


        function select(pointer,click,barco) {
            if (clicado === null) {
                console.log("has clickado el barco");
                clicado = barco;
            }else
            {
                tableroAliado.checkRectangle(clicado);
                clicado = null;
            }

        }

        function update() {
            game.world.bringToTop(flota);
        }



        //si se hace esto en la funcion de update no se renderiza
        function render(){
            if (clicado !== null && gameState === PART_ONE) {
                clicado.changePosition(game.input.x, game.input.y);
               
            }
        }



        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        
    </script>
</body>
</html>